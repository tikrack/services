<html>
  <head>
    <title>Tikrack API</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
    </style>
  </head>
  <body>
    <script>
      // تنظیمات اصلی API
      const API_CONFIG = {
        debug: new URLSearchParams(window.location.search).has('debug'),
        defaultResponseType: 'json'
      };

      // تابع برای ایجاد پاسخ استاندارد JSON
      function createJsonResponse(data, status = 200) {
        const responseData = {
          status,
          success: status >= 200 && status < 300,
          data,
          timestamp: new Date().toISOString()
        };

        if (API_CONFIG.debug) {
          document.body.innerHTML = `
            <h1>API Debug Mode</h1>
            <h2>Response:</h2>
            <pre>${JSON.stringify(responseData, null, 2)}</pre>
            <h2>Request Parameters:</h2>
            <pre>${JSON.stringify(Object.fromEntries(new URLSearchParams(window.location.search)), null, 2)}</pre>
          `;
        }

        return new Response(JSON.stringify(responseData), {
          status,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'X-API-Version': '1.0'
          }
        });
      }

      // سرویس‌های موجود در API
      const API_SERVICES = {
        TelegramSendBot: async (params) => {
          try {
            // اعتبارسنجی پارامترهای ضروری
            const requiredParams = ['token', 'chat_id', 'text'];
            const missingParams = requiredParams.filter(p => !params[p]);
            
            if (missingParams.length > 0) {
              throw new Error(`Missing required parameters: ${missingParams.join(', ')}`);
            }

            // ساخت URL درخواست به تلگرام
            const telegramUrl = new URL('https://telegram-send-js2.tikrackcode.workers.dev');
            telegramUrl.searchParams.append('token', params.token);
            telegramUrl.searchParams.append('id', params.chat_id);
            telegramUrl.searchParams.append('text', params.text);

            // ارسال درخواست به سرویس تلگرام
            const response = await fetch(telegramUrl.toString());
            const responseData = await response.json();

            if (!response.ok) {
              throw new Error(responseData.error || 'Unknown error from Telegram service');
            }

            return createJsonResponse({
              message: 'Message sent successfully',
              telegram_response: responseData
            });
          } catch (error) {
            return createJsonResponse({
              error: error.message,
              details: 'Failed to send Telegram message'
            }, 400);
          }
        },

        // می‌توانید سرویس‌های دیگر را اینجا اضافه کنید
        TestService: async () => {
          return createJsonResponse({
            message: 'Test service works!',
            services_available: Object.keys(API_SERVICES)
          });
        }
      };

      // تابع اصلی پردازش درخواست‌های API
      async function handleApiRequest() {
        const params = Object.fromEntries(new URLSearchParams(window.location.search));

        // اگر سرویس مشخص نشده باشد
        if (!params.service) {
          return createJsonResponse({
            error: 'No service specified',
            available_services: Object.keys(API_SERVICES),
            usage_example: '/?service=TelegramSendBot&token=XXX&chat_id=YYY&text=Hello'
          }, 400);
        }

        // اگر سرویس وجود نداشته باشد
        if (!API_SERVICES[params.service]) {
          return createJsonResponse({
            error: `Service '${params.service}' not found`,
            available_services: Object.keys(API_SERVICES)
          }, 404);
        }

        // اجرای سرویس مورد نظر
        try {
          return await API_SERVICES[params.service](params);
        } catch (error) {
          return createJsonResponse({
            error: 'Internal server error',
            details: error.message
          }, 500);
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        if (!API_CONFIG.debug) {
          document.body.style.display = 'none';
        }
        
        const apiResponse = await handleApiRequest();
        
        if (!API_CONFIG.debug) {
          window.API_RESPONSE = apiResponse;
          console.log('API response is available as window.API_RESPONSE');
        }
      });
    </script>
  </body>
</html>